<!-- ... ab <head> -->

<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<!-- ... am Ende von <body> -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
  const supabase = supabase.createClient(
    "https://lfptdjesepqdoolcxppw.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmcHRkamVzZXBxZG9vbGN4cHB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4MDk3OTMsImV4cCI6MjA2MDM4NTc5M30.i67qj_tTDvx9_TJiWHCo_RT8EnS71ZV7LpJIvlAXiFg"
  );

  let map;
  let circle = null;
  let marker = null;
  let userLat = 51.1657;
  let userLon = 10.4515;
  let markerGroup;
  const radiusInput = document.getElementById("radius");

  function drawCircle() {
    if (!map || !marker) return;

    const radiusKm = parseFloat(radiusInput.value);
    if (isNaN(radiusKm) || radiusKm <= 0) return;

    if (circle) map.removeLayer(circle);

    const center = marker.getLatLng();
    circle = L.circle(center, {
      radius: radiusKm * 1000,
      color: "green",
      fillColor: "#aaffaa",
      fillOpacity: 0.3,
    }).addTo(map);

    loadLocations(); // neu filtern
  }

  function isWithinRadius(lat, lon, centerLat, centerLon, radiusKm) {
    const R = 6371; // km
    const dLat = ((lat - centerLat) * Math.PI) / 180;
    const dLon = ((lon - centerLon) * Math.PI) / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos((centerLat * Math.PI) / 180) *
        Math.cos((lat * Math.PI) / 180) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c;
    return distance <= radiusKm;
  }

  async function loadLocations() {
    if (!map || !markerGroup) return;

    markerGroup.clearLayers();

    const { data, error } = await supabase.from("Locations").select("*");
    if (error) {
      console.error("Fehler beim Laden:", error.message);
      return;
    }

    const center = marker.getLatLng();
    const radiusKm = parseFloat(radiusInput.value);

    data.forEach((loc) => {
      if (!loc.latitude || !loc.longitude) return;

      if (isWithinRadius(loc.latitude, loc.longitude, center.lat, center.lng, radiusKm)) {
        const popup = `
          <strong>${loc.name || "Ohne Name"}</strong><br/>
          ${loc.description || ""}<br/>
          <em>${loc.hours || ""}</em>
        `;

        L.marker([loc.latitude, loc.longitude])
          .bindPopup(popup)
          .addTo(markerGroup);
      }
    });
  }

  function initMap(position) {
    userLat = position.coords.latitude;
    userLon = position.coords.longitude;

    map = L.map("map").setView([userLat, userLon], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
    }).addTo(map);

    markerGroup = L.markerClusterGroup();
    map.addLayer(markerGroup);

    marker = L.marker([userLat, userLon]).addTo(map);

    const provider = new window.GeoSearch.OpenStreetMapProvider();
    const searchControl = new window.GeoSearch.GeoSearchControl({
      provider: provider,
      style: "bar",
      searchLabel: "Suche nach Ort",
      showMarker: false,
      autoComplete: true,
      retainZoomLevel: false,
      keepResult: true,
      updateMap: true,
    });
    map.addControl(searchControl);

    map.on("geosearch/showlocation", function (result) {
      if (marker) map.removeLayer(marker);
      marker = L.marker([result.location.y, result.location.x]).addTo(map);
      map.setView([result.location.y, result.location.x], 13);
      drawCircle();
    });

    radiusInput.addEventListener("input", drawCircle);
    drawCircle();
  }

  window.onload = function () {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        initMap,
        function () {
          alert("Standortzugriff fehlgeschlagen. Standardposition wird verwendet.");
          initMap({ coords: { latitude: userLat, longitude: userLon } });
        }
      );
    } else {
      alert("Geolocation wird nicht unterstützt.");
      initMap({ coords: { latitude: userLat, longitude: userLon } });
    }
  };
</script>
